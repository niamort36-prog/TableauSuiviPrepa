<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Suivi Chantier - Alarmes</title>
    <style>
        :root {
            --primary-color: #0055a4;
            --secondary-color: #f1f5f9;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --header-bg: #0f172a;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; min-height: 100vh; }

        /* --- NAVBAR --- */
        .navbar { background-color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .nav-logo { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); cursor: pointer; }
        .nav-actions { display: flex; gap: 15px; }
        .btn-nav { background-color: transparent; color: #64748b; border: 1px solid #cbd5e1; padding: 8px 16px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .btn-nav.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-new { background-color: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        
        /* --- LAYOUT --- */
        .screen { padding: 30px; max-width: 1200px; margin: 0 auto; display: none; }
        .screen.active { display: block; }
        .projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-top: 20px; }
        .empty-state { text-align: center; color: #94a3b8; margin-top: 50px; padding: 40px; border: 2px dashed #cbd5e1; border-radius: 12px; }

        /* --- CARTE PROJET --- */
        .project-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid var(--border-color); cursor: pointer; transition: transform 0.2s; position: relative; border-left: 5px solid transparent; }
        .project-card:hover { transform: translateY(-3px); }
        /* Bordures d'√©tat sur la carte */
        .project-card.status-red { border-left-color: var(--danger-color); }
        .project-card.status-yellow { border-left-color: var(--warning-color); }
        .project-card.status-green { border-left-color: var(--success-color); }

        .card-header { margin-bottom: 15px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: flex-start; }
        .card-line-name { font-weight: bold; color: var(--primary-color); font-size: 1.1rem; display: block; }
        .card-meta { font-size: 0.85rem; color: #64748b; margin-top: 2px; }
        .card-body { display: flex; justify-content: space-between; align-items: start; }
        .card-info-block { flex: 1; margin-right: 10px; }
        .card-info-item { margin-bottom: 5px; display: flex; align-items: flex-start; gap: 5px; font-size: 0.9rem; }
        .card-travaux { margin-top: 8px; padding-top: 8px; border-top: 1px dashed #e2e8f0; font-size: 0.85rem; color: #475569; font-style: italic; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .btn-folder-card { margin-top: 10px; background-color: #e2e8f0; color: #475569; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }
        .mini-gauge { width: 60px; height: 60px; flex-shrink: 0; }
        
        /* Pastille d'√©tat g√©n√©ral */
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .dot-red { background-color: var(--danger-color); box-shadow: 0 0 5px var(--danger-color); }
        .dot-yellow { background-color: var(--warning-color); box-shadow: 0 0 5px var(--warning-color); }
        .dot-green { background-color: var(--success-color); }

        .badge-deplacement { background-color: #dbeafe; color: #1e40af; font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; font-weight: bold; display: inline-flex; align-items: center; gap: 4px; margin-top: 5px; }

        /* --- ARCHIVES --- */
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .folder-card { background-color: #fff9db; border: 1px solid #fcd34d; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: transform 0.2s; }
        .folder-card:hover { transform: scale(1.02); background-color: #fef3c7; }
        .folder-contents { margin-top: 20px; padding: 20px; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; display: none; }

        /* --- FORMULAIRE --- */
        #form-screen { padding: 30px; max-width: 900px; margin: 0 auto; padding-bottom: 100px; }
        .dashboard-container { background-color: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .selection-area { background-color: var(--secondary-color); padding: 20px; border-bottom: 1px solid var(--border-color); }
        select { width: 100%; padding: 12px; font-size: 1rem; border: 2px solid var(--primary-color); border-radius: 6px; }
        .line-header { background-color: var(--header-bg); color: white; padding: 20px; text-align: center; opacity: 0.5; transition: opacity 0.3s; }
        .line-info { display: flex; justify-content: center; gap: 15px; align-items: center; flex-wrap: wrap; font-weight: bold; }
        .tag { background-color: var(--primary-color); padding: 4px 10px; border-radius: 4px; font-size: 0.9rem; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; background-color: var(--secondary-color); border-bottom: 1px solid var(--border-color); }
        .form-group { display: flex; flex-direction: column; }
        .form-input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; }
        
        .tag-input-container { display: flex; gap: 5px; margin-bottom: 5px; }
        .tag-add-btn { background: var(--primary-color); color: white; border: none; border-radius: 4px; padding: 0 10px; cursor: pointer; font-weight: bold; }
        .tag-list { display: flex; flex-wrap: wrap; gap: 5px; min-height: 25px; }
        .tag-pill { background-color: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; border: 1px solid #bae6fd; }
        .tag-remove { cursor: pointer; font-weight: bold; color: #0284c7; }
        .tag-remove:hover { color: #ef4444; }

        .date-row { display: flex; align-items: center; gap: 10px; }
        .date-row input { flex: 1; }
        .date-separator { font-size: 0.8rem; color: #64748b; }

        .deplacement-container { display: flex; align-items: center; background: white; padding: 10px; border-radius: 6px; border: 1px solid #cbd5e1; margin-top: 5px; }
        .deplacement-checkbox { width: 20px; height: 20px; accent-color: #d97706; cursor: pointer; margin-right: 10px; }

        .category-section { padding: 0; border-bottom: 1px solid var(--border-color); }
        .category-header { padding: 20px 20px 10px 20px; }
        .category-title { color: var(--primary-color); font-size: 1.1rem; border-left: 4px solid var(--primary-color); padding-left: 10px; text-transform: uppercase; margin: 0; }
        
        /* STYLE DES TACHES AVEC ALARMES */
        .task-item { display: flex; align-items: center; padding: 12px 20px; border-bottom: 1px solid #f1f5f9; transition: background-color 0.3s; }
        .task-item:last-child { border-bottom: none; }
        
        /* √âtats d'alarme */
        .task-item.alarm-red { background-color: #fee2e2; border-left: 5px solid var(--danger-color); }
        .task-item.alarm-yellow { background-color: #fef3c7; border-left: 5px solid var(--warning-color); }
        .task-item.status-ok { background-color: #f0fdf4; border-left: 5px solid var(--success-color); }

        .task-checkbox { width: 20px; height: 20px; margin-right: 15px; cursor: pointer; accent-color: var(--primary-color); }
        .task-content { flex-grow: 1; display: flex; flex-direction: column; }
        .task-label { font-weight: 500; cursor: pointer; }
        .task-deadline { font-size: 0.8rem; color: #64748b; margin-top: 2px; }
        .alarm-text { font-weight: bold; font-size: 0.75rem; margin-left: 5px; }

        .inline-input { width: 100px; padding: 5px; margin-left: 10px; border: 1px solid #cbd5e1; border-radius: 4px; }
        textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; resize: vertical; }

        .action-buttons { display: flex; gap: 15px; margin-top: 20px; }
        .btn-validate { background-color: var(--success-color); color: white; border: none; padding: 15px; flex: 2; font-size: 1.1rem; font-weight: bold; cursor: pointer; border-radius: 8px; }
        .btn-archive { background-color: var(--secondary-color); color: #64748b; border: 1px solid #cbd5e1; padding: 15px; flex: 1; font-size: 1rem; font-weight: bold; cursor: pointer; border-radius: 8px; }
        .btn-archive:hover { background-color: #fee2e2; color: var(--danger-color); border-color: var(--danger-color); }

        .gauge-section { display: flex; justify-content: center; padding: 20px; background-color: #fff; border-bottom: 1px solid var(--border-color); }
        .gauge-container { width: 120px; height: 120px; position: relative; }
        .circular-chart { display: block; margin: 0 auto; max-width: 100%; max-height: 100%; }
        .circle-bg { fill: none; stroke: #eee; stroke-width: 3.8; }
        .circle { fill: none; stroke-width: 2.8; stroke-linecap: round; stroke: var(--primary-color); transition: stroke-dasharray 0.6s ease; }
        .percentage { fill: var(--text-color); font-family: sans-serif; font-weight: bold; font-size: 0.5em; text-anchor: middle; }

        @media (max-width: 600px) { .info-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-logo" onclick="switchTab('home')">‚ö° Suivi Chantier</div>
        <div class="nav-actions">
            <button class="btn-nav active" id="btn-tab-home" onclick="switchTab('home')">üìä En cours</button>
            <button class="btn-nav" id="btn-tab-archive" onclick="switchTab('archive')">üóÇÔ∏è Archives</button>
            <button class="btn-new" onclick="startNewProject()"><span>+</span> Nouveau</button>
        </div>
    </nav>

    <div id="home-screen" class="screen active">
        <h2 style="margin-top: 0; color: #334155;">Chantiers Actifs</h2>
        <div id="projects-list" class="projects-grid">
            <div class="empty-state">Aucun chantier actif.</div>
        </div>
    </div>

    <div id="archive-screen" class="screen">
        <h2 style="margin-top: 0; color: #334155;">Archives par Date</h2>
        <div id="archive-folders" class="folder-grid"></div>
        <div id="folder-viewer" class="folder-contents">
            <h3 id="folder-viewer-title" style="color:var(--primary-color); border-bottom:1px solid #eee; padding-bottom:10px;">D√©tails Dossier</h3>
            <div id="folder-projects-list" class="projects-grid"></div>
        </div>
    </div>

    <div id="form-screen" class="screen">
        <button style="background:none; border:none; text-decoration:underline; cursor:pointer; color:#64748b; margin-bottom:10px;" onclick="goBack()">‚Üê Annuler / Retour</button>
        
        <div class="dashboard-container">
            <div class="selection-area">
                <label>S√©lectionner une ligne :</label>
                <select id="line-select" onchange="updateLineInfo()"></select>
            </div>

            <div class="line-header" id="header-display">
                <div class="line-info">
                    <span class="tag" id="display-number">N¬∞ ---</span>
                    <span class="tag" id="display-tension">-- kV</span>
                    <span id="display-name">S√©lectionner une ligne...</span>
                </div>
            </div>

            <div class="gauge-section">
                <div class="gauge-container">
                    <svg viewBox="0 0 36 36" class="circular-chart" id="main-gauge">
                        <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <path class="circle" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <text x="18" y="20.35" class="percentage">0%</text>
                    </svg>
                </div>
            </div>

            <div class="info-grid">
                <div class="form-group"><label>CdT Attribu√©</label><input type="text" id="inp-cdt" class="form-input"></div>
                <div class="form-group"><label>CdT Suppl√©ant</label><input type="text" id="inp-cdt-sup" class="form-input"></div>
                
                <div class="form-group">
                    <label>Num√©ros OT</label>
                    <div class="tag-input-container">
                        <input type="text" id="inp-ot-add" class="form-input" placeholder="Ajouter OT..." style="flex:1">
                        <button class="tag-add-btn" onclick="addTag('ot')">+</button>
                    </div>
                    <div id="list-ot" class="tag-list"></div>
                </div>

                <div class="form-group">
                    <label>Num√©ros OI</label>
                    <div class="tag-input-container">
                        <input type="text" id="inp-oi-add" class="form-input" placeholder="Ajouter OI..." style="flex:1">
                        <button class="tag-add-btn" onclick="addTag('oi')">+</button>
                    </div>
                    <div id="list-oi" class="tag-list"></div>
                </div>

                <div class="form-group">
                    <label>Dates Consignation</label>
                    <div class="date-row">
                        <input type="date" id="date-cons-start" class="form-input">
                        <span class="date-separator">au</span>
                        <input type="date" id="date-cons-end" class="form-input">
                    </div>
                </div>

                <div class="form-group">
                    <label>Dates Chantier (R√©f√©rence pour Alarmes)</label>
                    <div class="date-row">
                        <input type="date" id="date-chantier-start" class="form-input" onchange="updateFormAlarms()">
                        <span class="date-separator">au</span>
                        <input type="date" id="date-chantier-end" class="form-input">
                    </div>
                    
                    <div class="deplacement-container">
                        <input type="checkbox" id="chk-deplacement" class="deplacement-checkbox">
                        <label for="chk-deplacement" style="font-weight:bold; cursor:pointer;">üöó D√©placement √† pr√©voir</label>
                    </div>
                </div>
                
                <div class="form-group" style="grid-column: span 2;">
                    <label style="font-weight: bold; color: var(--primary-color);">Description des Travaux</label>
                    <textarea id="inp-travaux" class="form-input" style="height: 60px;" placeholder="Ex: Remplacement isolateurs..."></textarea>
                </div>

                <div class="form-group" style="grid-column: span 2;">
                    <label>Lien Dossier / Chemin R√©seau</label>
                    <input type="text" id="inp-link" class="form-input" placeholder="Chemin r√©seau ou lien web">
                </div>
            </div>

            <div class="category-section">
                <div class="category-header"><h3 class="category-title">1. Mat√©riel Lignes</h3></div>
                
                <div class="task-item" id="row-chk-mat-cmd">
                    <input type="checkbox" id="chk-mat-cmd" class="task-checkbox" onchange="updateGauge(); updateFormAlarms()">
                    <div class="task-content">
                        <label for="chk-mat-cmd" class="task-label">Commande du mat√©riel</label>
                        <div class="task-deadline" id="date-chk-mat-cmd"></div>
                    </div>
                </div>
                <div class="task-item" id="row-chk-mat-recep">
                    <input type="checkbox" id="chk-mat-recep" class="task-checkbox" onchange="updateGauge(); updateFormAlarms()">
                    <div class="task-content">
                        <label for="chk-mat-recep" class="task-label">R√©ception mat√©riel</label>
                        <div class="task-deadline" id="date-chk-mat-recep"></div>
                    </div>
                </div>
                <div class="task-item" id="row-chk-mat-charge">
                    <input type="checkbox" id="chk-mat-charge" class="task-checkbox" onchange="updateGauge(); updateFormAlarms()">
                    <div class="task-content">
                        <label for="chk-mat-charge" class="task-label">Chargement mat√©riel</label>
                        <div class="task-deadline" id="date-chk-mat-charge"></div>
                    </div>
                </div>
            </div>

            <div class="category-section">
                <div class="category-header"><h3 class="category-title">2. Planification de l'intervention</h3></div>
                
                <div class="task-item" id="row-chk-plan-dt">
                    <input type="checkbox" id="chk-plan-dt" class="task-checkbox" onchange="updateGauge(); updateFormAlarms()">
                    <div class="task-content">
                        <label for="chk-plan-dt" class="task-label">DT/DICT, demande SNCF, autre...</label>
                        <div class="task-deadline" id="date-chk-plan-dt"></div>
                    </div>
                </div>
                <div class="task-item" id="row-chk-plan-besoin">
                    <input type="checkbox" id="chk-plan-besoin" class="task-checkbox" onchange="updateGauge(); updateFormAlarms()">
                    <div class="task-content">
                        <label for="chk-plan-besoin" class="task-label">Expression de besoins particulier</label>
                        <div class="task-deadline" id="date-chk-plan-besoin"></div>
                    </div>
                </div>
            </div>

            <div class="category-section">
                <div class="category-header"><h3 class="category-title">3. Outillage</h3></div>
                
                <div class="task-item" id="row-chk-out-devis">
                    <input type="checkbox" id="chk-out-devis" class="task-checkbox" onchange="updateGauge(); updateFormAlarms()">
                    <div class="task-content">
                        <label for="chk-out-devis" class="task-label">Devis moyen externe (nacelle...)</label>
                        <div class="task-deadline" id="date-chk-out-devis"></div>
                    </div>
                </div>
                <div class="task-item" id="row-chk-out-verif">
                    <input type="checkbox" id="chk-out-verif" class="task-checkbox" onchange="updateGauge(); updateFormAlarms()">
                    <div class="task-content">
                        <label for="chk-out-verif" class="task-label">V√©rification contr√¥le r√®glementaires</label>
                        <div class="task-deadline" id="date-chk-out-verif"></div>
                    </div>
                </div>
            </div>

            <div class="category-section">
                <div class="category-header"><h3 class="category-title">4. Ressources</h3></div>
                
                <div class="task-item"><label>Dur√©e du chantier</label><input type="text" id="inp-res-duree" class="inline-input"></div>
                <div class="task-item"><label>Nombre d'agents</label><input type="number" id="inp-res-agents" class="inline-input"></div>
                
                <div class="task-item" id="row-chk-res-vehic">
                    <input type="checkbox" id="chk-res-vehic" class="task-checkbox" onchange="updateGauge(); updateFormAlarms()">
                    <div class="task-content">
                        <label for="chk-res-vehic" class="task-label">V√©hicule √©quipe particulier</label>
                        <div class="task-deadline" id="date-chk-res-vehic"></div>
                    </div>
                </div>
            </div>

            <div class="category-section">
                <div class="category-header"><h3 class="category-title">5. Pr√©paration de travail</h3></div>
                
                <div class="task-item" id="row-chk-prep-visite">
                    <input type="checkbox" id="chk-prep-visite" class="task-checkbox" onchange="updateGauge(); updateFormAlarms()">
                    <div class="task-content">
                        <label for="chk-prep-visite" class="task-label">Visite sur place</label>
                        <div class="task-deadline" id="date-chk-prep-visite"></div>
                    </div>
                </div>
                <div class="task-item" id="row-chk-prep-veg">
                    <input type="checkbox" id="chk-prep-veg" class="task-checkbox" onchange="updateGauge(); updateFormAlarms()">
                    <div class="task-content">
                        <label for="chk-prep-veg" class="task-label">Travaux v√©g√©tation a pr√©voir</label>
                        <div class="task-deadline" id="date-chk-prep-veg"></div>
                    </div>
                </div>
                <div class="task-item" id="row-chk-prep-tiers">
                    <input type="checkbox" id="chk-prep-tiers" class="task-checkbox" onchange="updateGauge(); updateFormAlarms()">
                    <div class="task-content">
                        <label for="chk-prep-tiers" class="task-label">Contact tiers</label>
                        <div class="task-deadline" id="date-chk-prep-tiers"></div>
                    </div>
                </div>
                <div class="task-item" id="row-chk-prep-sign">
                    <input type="checkbox" id="chk-prep-sign" class="task-checkbox" onchange="updateGauge(); updateFormAlarms()">
                    <div class="task-content">
                        <label for="chk-prep-sign" class="task-label">Signature pr√©pa</label>
                        <div class="task-deadline" id="date-chk-prep-sign"></div>
                    </div>
                </div>
                <div class="task-item" id="row-chk-prep-valtec">
                    <input type="checkbox" id="chk-prep-valtec" class="task-checkbox" onchange="updateGauge(); updateFormAlarms()">
                    <div class="task-content">
                        <label for="chk-prep-valtec" class="task-label">Validation technique</label>
                        <div class="task-deadline" id="date-chk-prep-valtec"></div>
                    </div>
                </div>
                <div class="task-item" id="row-chk-prep-valhier">
                    <input type="checkbox" id="chk-prep-valhier" class="task-checkbox" onchange="updateGauge(); updateFormAlarms()">
                    <div class="task-content">
                        <label for="chk-prep-valhier" class="task-label">Validation hierarchiques</label>
                        <div class="task-deadline" id="date-chk-prep-valhier"></div>
                    </div>
                </div>
            </div>

            <div class="category-section" style="border:none;">
                <h3 class="category-title" style="margin-top:20px;">Notes</h3>
                <textarea id="inp-notes" placeholder="Commentaires..."></textarea>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn-archive" type="button" onclick="archiveProject()">üóÉÔ∏è Archiver</button>
            <button class="btn-validate" type="button" onclick="saveProject()">üíæ Valider (Actif)</button>
        </div>
    </div>

    <script>
        // CONFIGURATION DES D√âLAIS (en mois ou jours avant le d√©but chantier)
        // unit: 'm' (mois), 'd' (jours)
        const taskDelays = {
            'chk-mat-cmd': { amount: 3, unit: 'm' },
            'chk-mat-recep': { amount: 1, unit: 'm' },
            'chk-mat-charge': { amount: 1, unit: 'd' },
            
            'chk-plan-dt': { amount: 3, unit: 'm' },
            'chk-plan-besoin': { amount: 3, unit: 'm' },
            
            'chk-out-devis': { amount: 3, unit: 'm' },
            'chk-out-verif': { amount: 2, unit: 'm' },
            
            'chk-res-vehic': { amount: 1, unit: 'm' },
            
            'chk-prep-visite': { amount: 3, unit: 'm' },
            'chk-prep-veg': { amount: 1, unit: 'm' },
            'chk-prep-tiers': { amount: 3, unit: 'm' },
            'chk-prep-sign': { amount: 1, unit: 'm' },
            'chk-prep-valtec': { amount: 21, unit: 'd' }, // 3 semaines
            'chk-prep-valhier': { amount: 14, unit: 'd' } // 2 semaines
        };

        const linesDatabase = [
            { id: "6050", tension: "225 kV", name: "Aubusson - Eguzon" },
            { id: "6011", tension: "225 kV", name: "Aubusson - Mole" },
            { id: "6059", tension: "225 kV", name: "Aubusson-Ste Feyre" },
            { id: "4060", tension: "90 kV", name: "Aurence - Beaubreuil" },
            { id: "4061", tension: "90 kV", name: "Aurence - Maureix - Z - Magr√© - Z Mart" },
            { id: "4062", tension: "90 kV", name: "Aurence - St Martin le Vieux" },
            { id: "4063", tension: "90 kV", name: "Beaubreuil - Casseaux" },
            { id: "4064", tension: "90 kV", name: "Beaubreuil - Maureix" },
            { id: "4023", tension: "90 kV", name: "Beauregard - Donzenac - lez Peygnee" },
            { id: "4065", tension: "90 kV", name: "Bellac - Isle Jourdain" },
            { id: "4066", tension: "90 kV", name: "Bellac - Maureix" },
            { id: "4067", tension: "90 kV", name: "Bonnat - Gu√©ret" },
            { id: "4008", tension: "90 kV", name: "Borlette - Donzenac 1" },
            { id: "4015", tension: "90 kV", name: "Borlette - Montignac - Z - Beauregard" },
            { id: "3080", tension: "63 kV", name: "Borlette - Noailles" },
            { id: "4006", tension: "90 kV", name: "Borlette - Puypertus" },
            { id: "4016", tension: "90 kV", name: "Borlette - Donzenac 2" },
            { id: "4018", tension: "90 kV", name: "Bradacou - Gaucher - Z - Estivaux" },
            { id: "4068", tension: "90 kV", name: "Bradacou - Repaire c Rouverade" },
            { id: "4069", tension: "90 kV", name: "Br√©jon - Magr√©" },
            { id: "4070", tension: "90 kV", name: "Br√©jon - Tuquet - Z - Farges" },
            { id: "6024", tension: "225 kV", name: "Breuil - Chastang 1 - Donzenac" },
            { id: "7001", tension: "400 kV", name: "Breuil - Marmagne" },
            { id: "6025", tension: "225 kV", name: "Breuil - Peyrat le Chateau" },
            { id: "4071", tension: "90 kV", name: "Buelt - La Veytizou" },
            { id: "4072", tension: "90 kV", name: "Casseaux - Maureix - Z - Martinerie" },
            { id: "4073", tension: "90 kV", name: "Casseaux - Palais" },
            { id: "4074", tension: "90 kV", name: "Casseaux - Traverse" },
            { id: "4075", tension: "90 kV", name: "CGFP - Palais" },
            { id: "4076", tension: "90 kV", name: "Chabanais - Plaud" },
            { id: "4077", tension: "90 kV", name: "Champagnac - St Junien" },
            { id: "4078", tension: "90 kV", name: "Champagnac - St Martin le Vieux" },
            { id: "4079", tension: "90 kV", name: "Chatelus - Gu√©ret" },
            { id: "4080", tension: "90 kV", name: "Chatelus - Maureix -Z- Crotte Cadet-Z- Chatre" },
            { id: "7007", tension: "400 kV", name: "Civaux - Plaud" },
            { id: "4081", tension: "90 kV", name: "Confolens - St Junien" },
            { id: "3085", tension: "63 kV", name: "D√©gagnac - Gourdon - D√©gagnac" },
            { id: "3086", tension: "63 kV", name: "D√©gagnac - St Denis - Catus" },
            { id: "6039", tension: "225 kV", name: "Donzenac - Ferrouge" },
            { id: "4007", tension: "90 kV", name: "Donzenac - Gaucher" },
            { id: "4030", tension: "90 kV", name: "Donzenac - Pont de l'Elle 1" },
            { id: "4031", tension: "90 kV", name: "Donzenac - Pont de l'Elle 2" },
            { id: "4029", tension: "90 kV", name: "Donzenac - Saillant" },
            { id: "4082", tension: "90 kV", name: "Dun le Palestel - Eguzon" },
            { id: "4005", tension: "90 kV", name: "Egletons - Naves - Eybrix" },
            { id: "4083", tension: "90 kV", name: "Eguzon - les Vignes E1" },
            { id: "4084", tension: "90 kV", name: "Eguzon - les Vignes E2" },
            { id: "6051", tension: "225 kV", name: "Eguzon - Maureix" },
            { id: "6016", tension: "225 kV", name: "Eguzon - M√¥le 3" },
            { id: "6052", tension: "225 kV", name: "Eguzon - Montlu√ßon" },
            { id: "7008", tension: "400 kV", name: "Eguzon - Plaud" },
            { id: "7004", tension: "400 kV", name: "Eguzon - Rueyres" },
            { id: "6053", tension: "225 kV", name: "Eguzon - St Feyre" },
            { id: "3082", tension: "63 kV", name: "Ferouge - Gignac" },
            { id: "3084", tension: "63 kV", name: "Ferouge - Gourdon - La Mothe Fenelon" },
            { id: "3027", tension: "63 kV", name: "Ferouge - Sarlat" },
            { id: "3037", tension: "63 kV", name: "Ferouge - Souillac" },
            { id: "6038", tension: "225 kV", name: "Ferrouge - Talamet" },
            { id: "3081", tension: "63 kV", name: "Gignac - Noailles" },
            { id: "3083", tension: "63 kV", name: "Gourdon - Souillac - La Mothe Fenelon" },
            { id: "4085", tension: "90 kV", name: "Gu√©ret - Lavaud" },
            { id: "4086", tension: "90 kV", name: "Gu√©ret - St Feyre 1" },
            { id: "4087", tension: "90 kV", name: "Gu√©ret - St Feyre 2" },
            { id: "4088", tension: "90 kV", name: "Juniat - Maureix" },
            { id: "4089", tension: "90 kV", name: "Juniat - Peyrilhac" },
            { id: "4090", tension: "90 kV", name: "La C√¥te - la Souterraine E1" },
            { id: "4091", tension: "90 kV", name: "La C√¥te - les Vignes E1" },
            { id: "4092", tension: "90 kV", name: "La C√¥te - les Vignes E2 - Z - BonniChaud" },
            { id: "4093", tension: "90 kV", name: "La C√¥te - Ville / Grange E2 - Z - L'Age" },
            { id: "4094", tension: "90 kV", name: "La Souterraine - ville sous Grange E1" },
            { id: "4095", tension: "90 kV", name: "Lavaud - Mansat" },
            { id: "4016", tension: "90 kV", name: "Lubersac - Saillant" },
            { id: "4047", tension: "90 kV", name: "Lubersac - Traverse" },
            { id: "4097", tension: "90 kV", name: "Magnanels - La Souterraine" },
            { id: "4098", tension: "90 kV", name: "Mansat - Peyrat le Chateau" },
            { id: "4099", tension: "90 kV", name: "Maureix - Le Palais" },
            { id: "4100", tension: "90 kV", name: "Maureix - Peyrat - Z - Montlarron" },
            { id: "6054", tension: "225 kV", name: "Maureix - Peyrat le Ch√¢teau" },
            { id: "4101", tension: "90 kV", name: "Maureix - St L√©onard" },
            { id: "4102", tension: "90 kV", name: "Maureix - St Marc" },
            { id: "4103", tension: "90 kV", name: "Maureix - Ville sous Grange E1" },
            { id: "4104", tension: "90 kV", name: "Maureix - Ville sous Grange E2" },
            { id: "6001", tension: "225 kV", name: "M√¥le - St Feyre" },
            { id: "4105", tension: "90 kV", name: "Monceaux - La Veytizou" },
            { id: "4106", tension: "90 kV", name: "Monceaux - Peyrat le Ch√¢teau" },
            { id: "4110", tension: "90 kV", name: "Monceaux - Treignac 1" },
            { id: "4107", tension: "90 kV", name: "Monceaux - Treignac 2" },
            { id: "4010", tension: "90 kV", name: "Naves - Tulle" },
            { id: "4109", tension: "90 kV", name: "Peyrat - St S√©tiers - Z - Faux" },
            { id: "4096", tension: "90 kV", name: "Peyrilhac - St Junien" },
            { id: "4111", tension: "90 kV", name: "Plaud - St Junien 1" },
            { id: "4112", tension: "90 kV", name: "Plaud - St Junien 2" },
            { id: "4113", tension: "90 kV", name: "Plaud - Tannin Z Gorre" },
            { id: "4033", tension: "90 kV", name: "Puypertus - Tulle" },
            { id: "4113", tension: "90 kV", name: "Repaire - Tuquet" },
            { id: "4114", tension: "90 kV", name: "St Junien - Tannin Gorre 6" },
            { id: "4115", tension: "90 kV", name: "St L√©onard - La Veytizou" },
            { id: "4116", tension: "90 kV", name: "St Yrieix - La Traverse" }
        ];

        let projects = [];
        let currentEditingId = null;
        let currentOTs = [];
        let currentOIs = [];

        // --- CALCOLS DE DATE & ALARMES ---
        function calculateDeadline(startDateStr, delayObj) {
            if (!startDateStr) return null;
            const startDate = new Date(startDateStr);
            const deadline = new Date(startDate);

            if (delayObj.unit === 'm') {
                deadline.setMonth(deadline.getMonth() - delayObj.amount);
            } else if (delayObj.unit === 'd') {
                deadline.setDate(deadline.getDate() - delayObj.amount);
            }
            return deadline;
        }

        // Met √† jour les couleurs dans le formulaire
        function updateFormAlarms() {
            const startDateStr = document.getElementById('date-chantier-start').value;
            const today = new Date();
            // On reset l'heure pour comparer juste les dates
            today.setHours(0,0,0,0);

            for (const [taskId, delayObj] of Object.entries(taskDelays)) {
                const row = document.getElementById(`row-${taskId}`);
                const checkbox = document.getElementById(taskId);
                const deadlineText = document.getElementById(`date-${taskId}`);
                
                if (!row || !checkbox) continue;

                // Reset classes
                row.classList.remove('alarm-red', 'alarm-yellow', 'status-ok');
                deadlineText.innerHTML = "";

                if (checkbox.checked) {
                    row.classList.add('status-ok');
                    continue;
                }

                if (!startDateStr) continue; // Pas de date de chantier, pas d'alarme

                const deadline = calculateDeadline(startDateStr, delayObj);
                const formattedDeadline = deadline.toLocaleDateString('fr-FR');
                deadlineText.textContent = `Date butoir : ${formattedDeadline}`;

                // Logique alarme
                if (today > deadline) {
                    row.classList.add('alarm-red');
                    deadlineText.innerHTML += ` <span class="alarm-text" style="color:var(--danger-color)">‚ö†Ô∏è RETARD</span>`;
                } else {
                    // Calcul 1 mois avant deadline pour le jaune
                    const warningDate = new Date(deadline);
                    warningDate.setMonth(warningDate.getMonth() - 1);
                    
                    if (today >= warningDate && today <= deadline) {
                        row.classList.add('alarm-yellow');
                        deadlineText.innerHTML += ` <span class="alarm-text" style="color:#d97706">‚ö†Ô∏è √Ä faire bient√¥t</span>`;
                    }
                }
            }
        }

        // Calcule le statut global d'un projet pour la carte (Retourne 'red', 'yellow' ou 'green')
        function getProjectStatusColor(project) {
            if (!project.dateChantierStart) return 'green'; // Pas de date, on consid√®re vert
            
            const today = new Date();
            today.setHours(0,0,0,0);
            
            let hasYellow = false;

            for (const [taskId, delayObj] of Object.entries(taskDelays)) {
                // Si la t√¢che est coch√©e, on ignore
                if (project.checks && project.checks[taskId]) continue;

                const deadline = calculateDeadline(project.dateChantierStart, delayObj);
                
                // Rouge : Retard
                if (today > deadline) {
                    return 'red'; // Priorit√© absolue au rouge
                }

                // Jaune : Warning (1 mois avant)
                const warningDate = new Date(deadline);
                warningDate.setMonth(warningDate.getMonth() - 1);
                
                if (today >= warningDate && today <= deadline) {
                    hasYellow = true;
                }
            }

            return hasYellow ? 'yellow' : 'green';
        }

        // --- NAVIGATION & LOGIQUE ---
        function switchTab(tabName) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.btn-nav').forEach(b => b.classList.remove('active'));
            if (tabName === 'home') {
                document.getElementById('home-screen').classList.add('active');
                document.getElementById('btn-tab-home').classList.add('active');
                renderHomeProjects();
            } else if (tabName === 'archive') {
                document.getElementById('archive-screen').classList.add('active');
                document.getElementById('btn-tab-archive').classList.add('active');
                renderArchiveFolders();
            }
        }
        
        function startNewProject() {
            currentEditingId = null;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('form-screen').classList.add('active');
            resetForm();
        }

        function goBack() { switchTab('home'); currentEditingId = null; }

        function resetForm() {
            document.getElementById('line-select').value = "";
            document.querySelectorAll('#form-screen input, #form-screen textarea').forEach(i => i.value = "");
            document.querySelectorAll('#form-screen input[type="checkbox"]').forEach(i => i.checked = false);
            currentOTs = [];
            currentOIs = [];
            renderTags('ot');
            renderTags('oi');
            populateSelect();
            updateLineInfo();
            updateGauge();
            updateFormAlarms(); // Reset couleurs
        }

        function addTag(type) {
            const input = document.getElementById(`inp-${type}-add`);
            const val = input.value.trim();
            if(val) {
                if(type === 'ot') currentOTs.push(val); else currentOIs.push(val);
                input.value = "";
                renderTags(type);
            }
        }
        function removeTag(type, index) {
            if(type === 'ot') currentOTs.splice(index, 1); else currentOIs.splice(index, 1);
            renderTags(type);
        }
        function renderTags(type) {
            const list = document.getElementById(`list-${type}`);
            const data = type === 'ot' ? currentOTs : currentOIs;
            list.innerHTML = '';
            data.forEach((item, index) => {
                const tag = document.createElement('div');
                tag.className = 'tag-pill';
                tag.innerHTML = `${item} <span class="tag-remove" onclick="removeTag('${type}', ${index})">√ó</span>`;
                list.appendChild(tag);
            });
        }

        function populateSelect() {
            const select = document.getElementById('line-select');
            if (select.children.length > 1) return;
            linesDatabase.forEach(line => {
                const option = document.createElement('option');
                option.value = line.id;
                option.textContent = `${line.id} - ${line.name}`;
                select.appendChild(option);
            });
        }

        function updateLineInfo() {
            const select = document.getElementById('line-select');
            const selectedLine = linesDatabase.find(l => l.id === select.value);
            const header = document.getElementById('header-display');
            if (selectedLine) {
                document.getElementById('display-number').textContent = `N¬∞ ${selectedLine.id}`;
                document.getElementById('display-tension').textContent = selectedLine.tension;
                document.getElementById('display-name').textContent = selectedLine.name;
                header.style.opacity = "1";
                header.style.backgroundColor = "var(--primary-color)";
            } else {
                document.getElementById('display-number').textContent = "N¬∞ ---";
                document.getElementById('display-tension').textContent = "-- kV";
                document.getElementById('display-name').textContent = "S√©lectionner une ligne...";
                header.style.opacity = "0.5";
            }
        }

        function updateGauge() {
            const checkboxes = document.querySelectorAll('#form-screen .task-checkbox');
            let completed = 0;
            let checksState = {};
            checkboxes.forEach(box => { 
                checksState[box.id] = box.checked;
                if (box.checked) completed++; 
            });
            const percentage = checkboxes.length === 0 ? 0 : Math.round((completed / checkboxes.length) * 100);
            document.querySelector('#main-gauge .percentage').textContent = `${percentage}%`;
            document.querySelector('#main-gauge .circle').setAttribute('stroke-dasharray', `${percentage}, 100`);
            document.querySelector('#main-gauge .circle').style.stroke = percentage === 100 ? "var(--success-color)" : "var(--primary-color)";
            return { percentage, checksState };
        }

        function formatDateRange(start, end) {
            if(!start && !end) return "";
            if(start && !end) return `Du ${formatDateFr(start)}`;
            if(!start && end) return `Jusqu'au ${formatDateFr(end)}`;
            return `Du ${formatDateFr(start)} au ${formatDateFr(end)}`;
        }
        function formatDateFr(dateStr) {
            if(!dateStr) return "";
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        }

        function saveProject(isArchive = false) {
            const select = document.getElementById('line-select');
            if (!select.value) { alert("Merci de s√©lectionner une ligne."); return; }
            
            const gaugeData = updateGauge();
            
            const dConsStart = document.getElementById('date-cons-start').value;
            const dConsEnd = document.getElementById('date-cons-end').value;
            const dChantStart = document.getElementById('date-chantier-start').value;
            const dChantEnd = document.getElementById('date-chantier-end').value;

            const projectData = {
                uniqueId: currentEditingId || Date.now(),
                status: isArchive ? 'archived' : 'active',
                lineId: select.value,
                lineName: document.getElementById('display-name').textContent,
                lineNumber: document.getElementById('display-number').textContent,
                cdt: document.getElementById('inp-cdt').value,
                cdtSup: document.getElementById('inp-cdt-sup').value,
                ots: [...currentOTs],
                ois: [...currentOIs],
                dateConsStart: dConsStart,
                dateConsEnd: dConsEnd,
                dateChantierStart: dChantStart,
                dateChantierEnd: dChantEnd,
                displayDateCons: formatDateRange(dConsStart, dConsEnd),
                displayDateChantier: formatDateRange(dChantStart, dChantEnd),
                deplacement: document.getElementById('chk-deplacement').checked,
                duree: document.getElementById('inp-res-duree').value,
                agents: document.getElementById('inp-res-agents').value,
                notes: document.getElementById('inp-notes').value,
                folderLink: document.getElementById('inp-link').value,
                travaux: document.getElementById('inp-travaux').value,
                progress: gaugeData.percentage,
                checks: gaugeData.checksState
            };

            if (currentEditingId) {
                const index = projects.findIndex(p => p.uniqueId === currentEditingId);
                if(index !== -1) projects[index] = projectData;
            } else {
                projects.push(projectData);
            }

            if(isArchive) switchTab('archive'); else switchTab('home');
        }

        function editProject(projectId) {
            currentEditingId = projectId;
            const project = projects.find(p => p.uniqueId === projectId);
            if(!project) return;

            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('form-screen').classList.add('active');
            populateSelect();

            document.getElementById('line-select').value = project.lineId;
            updateLineInfo();
            document.getElementById('inp-cdt').value = project.cdt || "";
            document.getElementById('inp-cdt-sup').value = project.cdtSup || "";
            
            currentOTs = project.ots || [];
            currentOIs = project.ois || [];
            renderTags('ot');
            renderTags('oi');

            document.getElementById('date-cons-start').value = project.dateConsStart || "";
            document.getElementById('date-cons-end').value = project.dateConsEnd || "";
            document.getElementById('date-chantier-start').value = project.dateChantierStart || "";
            document.getElementById('date-chantier-end').value = project.dateChantierEnd || "";
            
            document.getElementById('chk-deplacement').checked = project.deplacement || false;
            document.getElementById('inp-res-duree').value = project.duree || "";
            document.getElementById('inp-res-agents').value = project.agents || "";
            document.getElementById('inp-notes').value = project.notes || "";
            document.getElementById('inp-link').value = project.folderLink || "";
            document.getElementById('inp-travaux').value = project.travaux || "";

            const checkboxes = document.querySelectorAll('#form-screen .task-checkbox');
            checkboxes.forEach(box => { box.checked = project.checks[box.id] || false; });
            
            updateGauge();
            updateFormAlarms(); // Calculer les alarmes √† l'ouverture
        }

        function archiveProject() { if(confirm("Archiver ce chantier ?")) saveProject(true); }

        function createProjectCard(p) {
            const card = document.createElement('div');
            card.className = `project-card`;
            card.onclick = () => editProject(p.uniqueId);
            
            // Calcul statut alarme pour la carte
            const status = getProjectStatusColor(p);
            card.classList.add(`status-${status}`);
            
            const strokeColor = p.progress === 100 ? '#10b981' : '#0055a4';
            let folderBtn = p.folderLink ? `<div style="margin-top:10px;"><button class="btn-folder-card" onclick="openLink('${p.folderLink.replace(/\\/g, '\\\\')}', event)">üìÅ Dossier</button></div>` : '';
            let travauxTxt = p.travaux ? `<div class="card-travaux">üìù ${p.travaux}</div>` : '';
            let deplacementBadge = p.deplacement ? `<div class="badge-deplacement">üöó D√©placement</div>` : '';
            let otDisplay = p.ots && p.ots.length ? `OT: ${p.ots.join(', ')}` : "OT: N/A";

            card.innerHTML = `
                <div class="card-header">
                    <div style="flex:1">
                        <span class="card-line-name">${p.lineName}</span>
                        <div class="card-meta">${p.lineNumber}</div>
                    </div>
                    <div class="status-dot dot-${status}" title="Statut planning"></div>
                </div>
                <div class="card-body">
                    <div class="card-info-block">
                        <div class="card-info-item">üë§ <strong>CdT:</strong> ${p.cdt || "N/A"}</div>
                        <div class="card-info-item">üî¢ <strong>${otDisplay}</strong></div>
                        <div class="card-info-item">üìÖ <strong>Consig:</strong> ${p.displayDateCons || "N/A"}</div>
                        ${deplacementBadge}
                        ${travauxTxt}
                        ${folderBtn}
                    </div>
                    <div class="mini-gauge">
                        <svg viewBox="0 0 36 36" class="circular-chart">
                            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path class="circle" stroke-dasharray="${p.progress}, 100" stroke="${strokeColor}" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <text x="18" y="20.35" class="percentage" style="font-size:0.6em;">${p.progress}%</text>
                        </svg>
                    </div>
                </div>
            `;
            return card;
        }

        function renderHomeProjects() {
            const list = document.getElementById('projects-list');
            list.innerHTML = '';
            const activeProjects = projects.filter(p => p.status !== 'archived');
            if (activeProjects.length === 0) list.innerHTML = '<div class="empty-state">Aucun chantier actif.</div>';
            else activeProjects.forEach(p => list.appendChild(createProjectCard(p)));
        }

        function renderArchiveFolders() {
            const list = document.getElementById('archive-folders');
            document.getElementById('folder-viewer').style.display = 'none';
            list.innerHTML = '';
            const archivedProjects = projects.filter(p => p.status === 'archived');
            if (archivedProjects.length === 0) { list.innerHTML = '<div class="empty-state">Aucune archive.</div>'; return; }

            const groups = {};
            archivedProjects.forEach(p => {
                const dateKey = p.dateChantierStart ? formatDateFr(p.dateChantierStart) : "Date inconnue";
                if (!groups[dateKey]) groups[dateKey] = [];
                groups[dateKey].push(p);
            });

            for (const [date, group] of Object.entries(groups)) {
                const folder = document.createElement('div');
                folder.className = 'folder-card';
                folder.onclick = () => {
                    const viewer = document.getElementById('folder-viewer');
                    document.getElementById('folder-viewer-title').textContent = `Archives du ${date}`;
                    const plist = document.getElementById('folder-projects-list');
                    plist.innerHTML = '';
                    group.forEach(p => plist.appendChild(createProjectCard(p)));
                    viewer.style.display = 'block';
                    viewer.scrollIntoView({ behavior: 'smooth' });
                };
                folder.innerHTML = `<div style="font-size:2rem;">üìÅ</div><div style="font-weight:bold;">${date}</div><div style="font-size:0.8rem;color:#b45309;">${group.length} chantier(s)</div>`;
                list.appendChild(folder);
            }
        }

        function openLink(link, event) {
            event.stopPropagation();
            if (link.startsWith('http')) window.open(link, '_blank');
            else prompt("Copiez ce chemin local :", link);
        }
    </script>
</body>
</html>