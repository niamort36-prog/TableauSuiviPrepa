<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Chantier - LIVE Firebase</title>
    <style>
        :root {
            --primary: #0f172a;
            --accent: #0ea5e9;
            --bg: #f1f5f9;
            --text: #334155;
            --border: #cbd5e1;
            
            --row-ok: #d1fae5;
            --row-warn: #fef08a;
            --row-late: #fecaca;
            --row-neutral: #ffffff;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; }

        /* --- NAVBAR --- */
        .navbar { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .nav-logo { font-size: 1.3rem; font-weight: 800; color: var(--primary); cursor: pointer; }
        .nav-actions { display: flex; gap: 10px; }
        .btn-nav { background: transparent; border: 1px solid var(--border); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .btn-nav.active { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-new { background: var(--accent); color: white; border: none; padding: 8px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* --- LAYOUT --- */
        .screen { max-width: 1200px; margin: 20px auto; padding: 0 20px; display: none; }
        .screen.active { display: block; }
        
        /* --- ACCUEIL --- */
        .projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 20px; }
        .project-card { background: white; border-radius: 12px; padding: 20px; border: 1px solid var(--border); cursor: pointer; transition: transform 0.2s; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .project-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        .card-green { border-left: 6px solid #10b981; }
        .card-yellow { border-left: 6px solid #eab308; }
        .card-red { border-left: 6px solid #ef4444; }

        .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
        .card-title { font-weight: 700; color: var(--primary); font-size: 1.1rem; }
        .card-dates { font-size: 0.9rem; color: #64748b; margin-top: 5px; display:flex; gap:5px; align-items:center;}
        
        .mini-gauge { width: 60px; height: 60px; position: absolute; top: 20px; right: 20px; }

        /* ALERTES SUR ACCUEIL */
        .card-alerts { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #e2e8f0; font-size: 0.8rem; }
        .alert-item { display: flex; align-items: center; gap: 5px; margin-bottom: 3px; font-weight: 600; }
        .alert-red { color: #dc2626; }
        .alert-orange { color: #d97706; }

        /* --- FORMULAIRE --- */
        .dashboard-container { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 20px; border: 1px solid var(--border); }
        .header-bar { background: var(--primary); color: white; padding: 20px; text-align: center; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 25px; border-bottom: 1px solid var(--border); }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-label { font-size: 0.8rem; font-weight: 700; color: #475569; text-transform: uppercase; }
        .form-input { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95rem; }

        /* TAGS */
        .input-group-row { display: flex; gap: 5px; }
        .btn-add-tag { background: var(--primary); color: white; border: none; padding: 0 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .tag-pill { background: #e0f2fe; color: #0369a1; padding: 2px 10px; border-radius: 15px; font-size: 0.85rem; border: 1px solid #bae6fd; display: inline-flex; align-items: center; gap: 5px; margin: 2px; }

        /* TABLEAU TACHES */
        .category-header { background: #e2e8f0; padding: 12px 20px; font-weight: 800; color: var(--primary); text-transform: uppercase; border-top: 1px solid #ccc; border-bottom: 1px solid #ccc; font-size: 1rem; }
        .task-row { display: flex; align-items: center; padding: 15px 20px; border-bottom: 1px solid #e2e8f0; transition: background-color 0.2s; gap: 15px; }
        
        .row-ok { background-color: var(--row-ok) !important; border-left: 5px solid #10b981; }
        .row-warn { background-color: var(--row-warn) !important; border-left: 5px solid #eab308; }
        .row-late { background-color: var(--row-late) !important; border-left: 5px solid #ef4444; }
        .row-neutral { background-color: white; border-left: 5px solid transparent; }

        .task-name { flex: 2; font-weight: 600; font-size: 0.95rem; color: #334155; }
        .task-deadline { flex: 1; font-size: 0.9rem; font-weight: bold; color: #b91c1c; text-align: center; background: rgba(255,255,255,0.5); padding: 5px; border-radius: 4px; }
        .task-actions { flex: 1; display: flex; justify-content: flex-end; }

        .btn-toggle { border: 1px solid #94a3b8; background: white; padding: 8px 16px; border-radius: 4px; font-weight: bold; color: #64748b; cursor: pointer; margin-left: 5px; }
        .btn-toggle.active-yes { background: #10b981; color: white; border-color: #10b981; }
        .btn-toggle.active-no { background: #64748b; color: white; border-color: #64748b; }
        .input-manual { padding: 8px; border: 1px solid #94a3b8; border-radius: 4px; width: 100px; text-align: center; }

        /* STICKY FOOTER */
        .footer-sticky { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: white; padding: 15px 30px; 
            box-shadow: 0 -4px 15px rgba(0,0,0,0.1); border-top: 1px solid var(--border);
            display: flex; gap: 15px; justify-content: flex-end; z-index: 2000;
        }
        .btn-action { padding: 12px 30px; border-radius: 8px; border: none; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-save { background: var(--success-color); background-color: #10b981; color: white; flex-grow: 1; max-width: 500px; }
        .btn-save:hover { background-color: #059669; transform: scale(1.02); }
        .btn-other { background: #6366f1; color: white; }
        .btn-arch { background: #94a3b8; color: white; }

        .circular-chart { display: block; margin: 0 auto; max-width: 100%; max-height: 250px; }
        .circle-bg { fill: none; stroke: #eee; stroke-width: 3.8; }
        .circle { fill: none; stroke-width: 2.8; stroke-linecap: round; transition: stroke-dasharray 0.6s ease; }
        .percentage { fill: #0f172a; font-family: sans-serif; font-weight: bold; font-size: 0.5em; text-anchor: middle; }

        @media print {
            .navbar, .footer-sticky, .btn-add-tag, .tag-remove { display: none !important; }
            .screen { display: block !important; margin: 0; padding: 0; }
            .dashboard-container { box-shadow: none; border: 1px solid #000; }
            .row-ok { background-color: #eee !important; border-left: 2px solid black; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-logo" onclick="goHome()">‚ö° SUIVI CHANTIER (Live)</div>
        <div class="nav-actions">
            <button class="btn-nav active" id="nav-home" onclick="goHome()">En cours</button>
            <button class="btn-nav" id="nav-arch" onclick="goArchive()">Archives</button>
            <button class="btn-new" onclick="newItem()">+ NOUVEAU</button>
        </div>
    </nav>

    <div id="screen-home" class="screen active">
        <div id="grid-projects" class="projects-grid"></div>
    </div>

    <div id="screen-archive" class="screen">
        <h3>üìÇ Archives</h3>
        <div id="grid-archives" class="projects-grid"></div>
    </div>

    <div id="screen-form" class="screen">
        <button onclick="goHome()" style="background:none; border:none; cursor:pointer; font-weight:bold; color:#64748b; margin-bottom:10px;">‚Üê Retour Accueil</button>

        <div class="dashboard-container">
            <div class="header-bar">
                <h2 id="display-line-header" style="margin:0; font-size:1.5rem">NOUVEAU CHANTIER</h2>
                <div id="display-line-sub" style="opacity:0.8">S√©lectionnez une ligne</div>
            </div>

            <div style="background:white; padding:15px; display:flex; justify-content:center; border-bottom:1px solid #eee">
                <div style="width:100px; height:100px; position:relative;">
                    <svg viewBox="0 0 36 36" class="circular-chart">
                        <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        <path class="circle" id="gauge-circle-form" stroke-dasharray="0, 100" stroke="#0055a4" fill="none" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                    </svg>
                    <div id="gauge-text-form" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-weight:bold;">0%</div>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group" style="grid-column: span 2">
                    <label class="form-label">Ligne HTB</label>
                    <select id="inp-line" class="form-input" onchange="updateHeader()"></select>
                </div>
                
                <div class="form-group"><label class="form-label">Charg√© de Travaux (CdT)</label><input id="inp-cdt" class="form-input"></div>
                <div class="form-group"><label class="form-label">CdT Suppl√©ant</label><input id="inp-cdt-sup" class="form-input"></div>

                <div class="form-group"><label class="form-label">D√©but Chantier</label><input type="date" id="inp-start" class="form-input" onchange="refreshUI()"></div>
                <div class="form-group"><label class="form-label">Fin Chantier</label><input type="date" id="inp-end" class="form-input" onchange="refreshUI()"></div>

                <div class="form-group"><label class="form-label">D√©but Consignation</label><input type="date" id="inp-cons-start" class="form-input"></div>
                <div class="form-group"><label class="form-label">Fin Consignation</label><input type="date" id="inp-cons-end" class="form-input"></div>

                <div class="form-group">
                    <label class="form-label">N¬∞ OT (Entr√©e pour ajouter)</label>
                    <div class="input-group-row"><input id="inp-ot-add" class="form-input" style="flex:1" onkeypress="if(event.key==='Enter') addTag('ot')"><button class="btn-add-tag" onclick="addTag('ot')">+</button></div>
                    <div id="list-ot" style="margin-top:5px"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">N¬∞ OI (Entr√©e pour ajouter)</label>
                    <div class="input-group-row"><input id="inp-oi-add" class="form-input" style="flex:1" onkeypress="if(event.key==='Enter') addTag('oi')"><button class="btn-add-tag" onclick="addTag('oi')">+</button></div>
                    <div id="list-oi" style="margin-top:5px"></div>
                </div>

                <div class="form-group" style="grid-column: span 2">
                    <label class="form-label">Description</label>
                    <textarea id="inp-desc" class="form-input" rows="2"></textarea>
                </div>

                <div class="form-group" style="grid-column: span 2">
                    <label style="cursor:pointer; font-weight:600; color:#d97706">
                        <input type="checkbox" id="inp-depl"> üöó D√©placement √† pr√©voir
                    </label>
                </div>
            </div>

            <div id="container-tasks-main"></div>
        </div>

        <div class="footer-sticky">
            <button class="btn-action btn-arch" onclick="doArchive()">üóÉÔ∏è Archiver</button>
            <button class="btn-action btn-other" onclick="goPrepa()">üìÑ Pr√©pa (Suite)</button>
            <button class="btn-action btn-save" onclick="save(false)">üíæ ENREGISTRER</button>
        </div>
    </div>

    <div id="screen-prepa" class="screen">
        <button onclick="switchScreen('screen-form')" style="margin-bottom:10px; cursor:pointer">‚Üê Retour</button>
        <div class="dashboard-container">
            <div class="header-bar" style="background:#6366f1"><h2>D√âTAILS TECHNIQUES</h2></div>
            <div id="container-tasks-prepa"></div>
        </div>
        <div class="footer-sticky">
            <button class="btn-action btn-other" onclick="switchScreen('screen-form')">Retour</button>
            <button class="btn-action btn-save" onclick="save(false)">üíæ ENREGISTRER TOUT</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        // CONFIG UTILISATEUR
        const firebaseConfig = {
            apiKey: "AIzaSyDD3isHTYPpXYQg9O0uBRkCGkjtB1JaxB4",
            authDomain: "suivichantier-b001e.firebaseapp.com",
            databaseURL: "https://suivichantier-b001e-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "suivichantier-b001e",
            storageBucket: "suivichantier-b001e.firebasestorage.app",
            messagingSenderId: "795720545138",
            appId: "1:795720545138:web:c03aa428dcfacb393563eb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // DONNEES STATIQUES
        const dbLignes = [
            {id:"6050",t:"225 kV",n:"Aubusson - Eguzon"},{id:"6011",t:"225 kV",n:"Aubusson - Mole"},{id:"6059",t:"225 kV",n:"Aubusson-Ste Feyre"},
            {id:"4060",t:"90 kV",n:"Aurence - Beaubeuil"},{id:"4061",t:"90 kV",n:"Aurence - Maureix"},{id:"4062",t:"90 kV",n:"Aurence - St Martin"},
            {id:"4063",t:"90 kV",n:"Beaubreuil - Casseaux"},{id:"4064",t:"90 kV",n:"Beaubreuil - Maureix"},{id:"4023",t:"90 kV",n:"Beauregard - Donzenac"},
            {id:"4065",t:"90 kV",n:"Bellac - Isle Jourdain"},{id:"4066",t:"90 kV",n:"Bellac - Maureix"},{id:"4067",t:"90 kV",n:"Bonnat - Gu√©ret"},
            {id:"4008",t:"90 kV",n:"Borlette - Donzenac 1"},{id:"4015",t:"90 kV",n:"Borlette - Montignac"},{id:"3080",t:"63 kV",n:"Borlette - Noailles"},
            {id:"4006",t:"90 kV",n:"Borlette - Puypertus"},{id:"4016",t:"90 kV",n:"Borlette - Donzenac 2"},{id:"4018",t:"90 kV",n:"Bradacou - Gaucher"},
            {id:"4068",t:"90 kV",n:"Bradacou - Repaire"},{id:"4069",t:"90 kV",n:"Br√©jon - Magr√©"},{id:"4070",t:"90 kV",n:"Br√©jon - Tuquet"},
            {id:"6024",t:"225 kV",n:"Breuil - Chastang"},{id:"7001",t:"400 kV",n:"Breuil - Marmagne"},{id:"6025",t:"225 kV",n:"Breuil - Peyrat"},
            {id:"4071",t:"90 kV",n:"Buelt - La Veytizou"},{id:"4072",t:"90 kV",n:"Casseaux - Maureix"},{id:"4073",t:"90 kV",n:"Casseaux - Palais"},
            {id:"4074",t:"90 kV",n:"Casseaux - Traverse"},{id:"4075",t:"90 kV",n:"CGFP - Palais"},{id:"4076",t:"90 kV",n:"Chabanais - Plaud"},
            {id:"4077",t:"90 kV",n:"Champagnac - St Junien"},{id:"4078",t:"90 kV",n:"Champagnac - St Martin"},{id:"4079",t:"90 kV",n:"Chatelus - Gu√©ret"},
            {id:"4080",t:"90 kV",n:"Chatelus - Maureix"},{id:"7007",t:"400 kV",n:"Civaux - Plaud"},{id:"4081",t:"90 kV",n:"Confolens - St Junien"},
            {id:"3085",t:"63 kV",n:"D√©gagnac - Gourdon"},{id:"3086",t:"63 kV",n:"D√©gagnac - St Denis"},{id:"6039",t:"225 kV",n:"Donzenac - Ferrouge"},
            {id:"4007",t:"90 kV",n:"Donzenac - Gaucher"},{id:"4030",t:"90 kV",n:"Donzenac - Pont Elle 1"},{id:"4031",t:"90 kV",n:"Donzenac - Pont Elle 2"},
            {id:"4029",t:"90 kV",n:"Donzenac - Saillant"},{id:"4082",t:"90 kV",n:"Dun - Eguzon"},{id:"4005",t:"90 kV",n:"Egletons - Naves"},
            {id:"4083",t:"90 kV",n:"Eguzon - Vignes 1"},{id:"4084",t:"90 kV",n:"Eguzon - Vignes 2"},{id:"6051",t:"225 kV",n:"Eguzon - Maureix"},
            {id:"6016",t:"225 kV",n:"Eguzon - M√¥le 3"},{id:"6052",t:"225 kV",n:"Eguzon - Montlu√ßon"},{id:"7008",t:"400 kV",n:"Eguzon - Plaud"},
            {id:"7004",t:"400 kV",n:"Eguzon - Rueyres"},{id:"6053",t:"225 kV",n:"Eguzon - St Feyre"},{id:"3082",t:"63 kV",n:"Ferouge - Gignac"},
            {id:"3084",t:"63 kV",n:"Ferouge - Gourdon"},{id:"3027",t:"63 kV",n:"Ferouge - Sarlat"},{id:"3037",t:"63 kV",n:"Ferouge - Souillac"},
            {id:"6038",t:"225 kV",n:"Ferrouge - Talamet"},{id:"3081",t:"63 kV",n:"Gignac - Noailles"},{id:"3083",t:"63 kV",n:"Gourdon - Souillac"},
            {id:"4085",t:"90 kV",n:"Gu√©ret - Lavaud"},{id:"4086",t:"90 kV",n:"Gu√©ret - St Feyre 1"},{id:"4087",t:"90 kV",n:"Gu√©ret - St Feyre 2"},
            {id:"4088",t:"90 kV",n:"Juniat - Maureix"},{id:"4089",t:"90 kV",n:"Juniat - Peyrilhac"},{id:"4090",t:"90 kV",n:"La C√¥te - Souterraine"},
            {id:"4091",t:"90 kV",n:"La C√¥te - Vignes 1"},{id:"4092",t:"90 kV",n:"La C√¥te - Vignes 2"},{id:"4093",t:"90 kV",n:"La C√¥te - Ville"},
            {id:"4094",t:"90 kV",n:"Souterraine - Ville"},{id:"4095",t:"90 kV",n:"Lavaud - Mansat"},{id:"4016",t:"90 kV",n:"Lubersac - Saillant"},
            {id:"4047",t:"90 kV",n:"Lubersac - Traverse"},{id:"4097",t:"90 kV",n:"Magnanels - Souterraine"},{id:"4098",t:"90 kV",n:"Mansat - Peyrat"},
            {id:"4099",t:"90 kV",n:"Maureix - Le Palais"},{id:"4100",t:"90 kV",n:"Maureix - Peyrat"},{id:"6054",t:"225 kV",n:"Maureix - Peyrat 2"},
            {id:"4101",t:"90 kV",n:"Maureix - St L√©onard"},{id:"4102",t:"90 kV",n:"Maureix - St Marc"},{id:"4103",t:"90 kV",n:"Maureix - Ville 1"},
            {id:"4104",t:"90 kV",n:"Maureix - Ville 2"},{id:"6001",t:"225 kV",n:"M√¥le - St Feyre"},{id:"4105",t:"90 kV",n:"Monceaux - Veytizou"},
            {id:"4106",t:"90 kV",n:"Monceaux - Peyrat"},{id:"4110",t:"90 kV",n:"Monceaux - Treignac 1"},{id:"4107",t:"90 kV",n:"Monceaux - Treignac 2"},
            {id:"4010",t:"90 kV",n:"Naves - Tulle"},{id:"4109",t:"90 kV",n:"Peyrat - St S√©tiers"},{id:"4096",t:"90 kV",n:"Peyrilhac - St Junien"},
            {id:"4111",t:"90 kV",n:"Plaud - St Junien 1"},{id:"4112",t:"90 kV",n:"Plaud - St Junien 2"},{id:"4113",t:"90 kV",n:"Plaud - Tannin"},
            {id:"4033",t:"90 kV",n:"Puypertus - Tulle"},{id:"4113",t:"90 kV",n:"Repaire - Tuquet"},{id:"4114",t:"90 kV",n:"St Junien - Tannin"},
            {id:"4115",t:"90 kV",n:"St L√©onard - Veytizou"},{id:"4116",t:"90 kV",n:"St Yrieix - Traverse"}
        ];

        const confLog = [
            {cat:"1. MAT√âRIEL LIGNES", t:[
                {id:"m1",l:"Commande du mat√©riel",d:90},
                {id:"m2",l:"R√©ception mat√©riel",d:30},
                {id:"m3",l:"Chargement mat√©riel",d:1}
            ]},
            {cat:"2. PLANIFICATION DE L'INTERVENTION", t:[
                {id:"p1",l:"DT/DICT, demande SNCF, autre...",d:90},
                {id:"p2",l:"Expression de besoins particulier (MALT, RH...)",d:90}
            ]},
            {cat:"3. OUTILLAGE", t:[
                {id:"o1",l:"Devis moyen externe (nacelle...)",d:90},
                {id:"o2",l:"V√©rification contr√¥le r√®glementaires engins",d:60}
            ]},
            {cat:"4. RESSOURCES", t:[
                {id:"r_dur",l:"Dur√©e du chantier", type:'input'},
                {id:"r_agt",l:"Nombre d'agents", type:'input'},
                {id:"r_veh",l:"V√©hicule √©quipe particulier (nacelle, treuil...)",d:30}
            ]},
            {cat:"5. PR√âPARATION DE TRAVAIL", t:[
                {id:"pr1",l:"Visite sur place",d:90},
                {id:"pr2",l:"Travaux v√©g√©tation √† pr√©voir",d:30},
                {id:"pr3",l:"Contact tiers",d:90},
                {id:"pr4",l:"Signature pr√©pa",d:30},
                {id:"pr5",l:"Validation technique",d:21},
                {id:"pr6",l:"Validation hierarchiques",d:14}
            ]}
        ];
        const confPrep = [
            {cat:"DOCUMENTS TECHNIQUES", t:[{id:"d1",l:"NIP",d:7},{id:"d2",l:"Constat Ad√©quation",d:0},{id:"d3",l:"Mode Op√©ratoire",d:0},{id:"d4",l:"Calculs",d:0},{id:"d5",l:"PPE",d:0},{id:"d6",l:"MALT/CC",d:0},{id:"d7",l:"Liste Mat√©riel",d:0},{id:"d8",l:"Liste Outillage",d:0}]}
        ];

        let projects = [];
        let curId = null;
        let states = {};
        let ots = []; let ois = [];

        // INIT
        window.onload = () => {
            // Populate select
            const sel = document.getElementById('inp-line');
            sel.innerHTML = '<option value="">-- Choisir une ligne --</option>';
            dbLignes.sort((a,b)=>a.id.localeCompare(b.id)).forEach(l => { sel.innerHTML += `<option value="${l.id}">${l.id} - ${l.n}</option>`; });
            
            buildForm(); 
            // renderHome sera appel√© par le listener Firebase
        };

        // --- ECOUTE DATABASE FIREBASE ---
        const dbRef = ref(db, 'chantiers');
        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            // Convertir objet Firebase en tableau JS
            projects = data ? Object.values(data) : [];
            // Mettre √† jour l'affichage si on est sur l'accueil ou archive
            if(document.getElementById('screen-home').classList.contains('active')) renderHome();
            if(document.getElementById('screen-archive').classList.contains('active')) renderGrid('grid-archives', true);
        });

        // --- CONSTRUCTION FORMULAIRE ---
        function buildForm() {
            const c = document.getElementById('container-tasks-main'); c.innerHTML = '';
            confLog.forEach(grp => {
                let html = `<div class="category-header">${grp.cat}</div>`;
                grp.t.forEach(task => {
                    let actionHtml = '';
                    if(task.type === 'input') {
                        actionHtml = `<input class="input-manual" id="val-${task.id}" placeholder="..." onchange="refreshUI()">`;
                    } else {
                        actionHtml = `
                        <div class="toggle-switch">
                            <button class="btn-toggle" id="btn-no-${task.id}" onclick="set('${task.id}','no')">NON</button>
                            <button class="btn-toggle" id="btn-yes-${task.id}" onclick="set('${task.id}','yes')">OUI</button>
                        </div>`;
                    }

                    html += `
                    <div class="task-row row-neutral" id="row-${task.id}">
                        <div class="task-name">${task.l}</div>
                        <div class="task-deadline" id="dead-${task.id}"></div>
                        <div class="task-actions">${actionHtml}</div>
                    </div>`;
                });
                c.innerHTML += html;
            });
            const c2 = document.getElementById('container-tasks-prepa'); c2.innerHTML = '';
            confPrep.forEach(grp => {
                let html = `<div class="category-header">${grp.cat}</div>`;
                grp.t.forEach(task => {
                    html += `
                    <div class="task-row row-neutral" id="row-${task.id}">
                        <div class="task-name">${task.l}</div>
                        <div class="task-deadline" id="dead-${task.id}"></div>
                        <div class="task-actions">
                            <div class="toggle-switch">
                                <button class="btn-toggle" id="btn-no-${task.id}" onclick="set('${task.id}','no')">NON</button>
                                <button class="btn-toggle" id="btn-yes-${task.id}" onclick="set('${task.id}','yes')">OUI</button>
                            </div>
                        </div>
                    </div>`;
                });
                c2.innerHTML += html;
            });
        }

        // --- LOGIQUE ---
        function set(tid, val) { states[tid] = (states[tid] === val) ? null : val; refreshUI(); }
        function addTag(type) { const v = document.getElementById('inp-'+type+'-add').value.trim(); if(v) { (type==='ot'?ots:ois).push(v); document.getElementById('inp-'+type+'-add').value=''; renderTags(type); }}
        function renderTags(type) { document.getElementById('list-'+type).innerHTML = (type==='ot'?ots:ois).map((v,i)=>`<span class="tag-pill">${v}<span onclick="removeTag('${type}',${i})" style="cursor:pointer;margin-left:5px">√ó</span></span>`).join(''); }
        function removeTag(type,i) { if(type==='ot')ots.splice(i,1);else ois.splice(i,1); renderTags(type); }

        function refreshUI() {
            const start = document.getElementById('inp-start').value;
            const today = new Date(); today.setHours(0,0,0,0);
            let doneCount = 0; let totalCount = 0;

            const processTask = (t) => {
                if(t.type === 'input') {
                    const inp = document.getElementById('val-'+t.id);
                    const row = document.getElementById('row-'+t.id);
                    if(inp && row) {
                        if(inp.value && inp.value.trim() !== "") { row.className = 'task-row row-ok'; doneCount++; } 
                        else { row.className = 'task-row row-neutral'; }
                    }
                    totalCount++;
                    return;
                }
                const s = states[t.id];
                const row = document.getElementById('row-'+t.id);
                const deadEl = document.getElementById('dead-'+t.id);
                const bY = document.getElementById('btn-yes-'+t.id);
                const bN = document.getElementById('btn-no-'+t.id);
                
                if(!row) return;

                row.className = 'task-row row-neutral';
                deadEl.textContent = '';
                bY.classList.remove('active-yes'); bN.classList.remove('active-no');
                
                if(s === 'yes') bY.classList.add('active-yes');
                if(s === 'no') bN.classList.add('active-no');

                if(s) {
                    row.classList.add('row-ok'); doneCount++;
                } else if(start && t.d) {
                    const d = new Date(start); d.setDate(d.getDate() - t.d);
                    deadEl.textContent = `Butoir : ${d.toLocaleDateString()}`;
                    if(today > d) row.classList.add('row-late');
                    else {
                        let warn = new Date(d);
                        if(t.d >= 30) warn.setMonth(warn.getMonth()-1); else warn.setDate(warn.getDate()-5);
                        if(today >= warn) row.classList.add('row-warn');
                    }
                }
                totalCount++;
            };

            [...confLog.flatMap(x=>x.t), ...confPrep.flatMap(x=>x.t)].forEach(processTask);

            const pct = totalCount ? Math.round((doneCount/totalCount)*100) : 0;
            document.getElementById('gauge-text-form').textContent = pct + '%';
            document.getElementById('gauge-circle-form').setAttribute('stroke-dasharray', `${pct}, 100`);
            document.getElementById('gauge-circle-form').setAttribute('stroke', pct===100?'#10b981':'#0055a4');
        }

        function updateHeader() {
            const v = document.getElementById('inp-line').value;
            const l = dbLignes.find(x=>x.id===v);
            if(l) {
                document.getElementById('display-line-header').textContent = `${l.t} - ${l.n}`.toUpperCase();
                document.getElementById('display-line-sub').textContent = `Code Liaison: ${l.id}`;
            }
        }
        function switchScreen(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function goHome() { switchScreen('screen-home'); renderHome(); }
        function goArchive() { switchScreen('screen-archive'); renderGrid('grid-archives', true); }
        function goPrepa() { switchScreen('screen-prepa'); refreshUI(); }

        // --- SAUVEGARDE SUR FIREBASE ---
        function save(arch) {
            try {
                const lineId = document.getElementById('inp-line').value;
                if(!lineId) { alert("Selectionnez une ligne"); return; }
                const l = dbLignes.find(x=>x.id===lineId);

                // Input manuels (Securis√©)
                const manualData = {};
                confLog.forEach(g => g.t.forEach(t => {
                    if(t.type==='input') {
                        const el = document.getElementById('val-'+t.id);
                        manualData[t.id] = el ? el.value : "";
                    }
                }));

                // Deplacement (Securis√©)
                const elDepl = document.getElementById('inp-depl');
                const isDepl = elDepl ? elDepl.checked : false;

                const allT = [...confLog.flatMap(x=>x.t), ...confPrep.flatMap(x=>x.t)];
                let done = 0;
                allT.forEach(t => {
                    if(t.type==='input') { if(manualData[t.id]) done++; }
                    else { if(states[t.id]) done++; }
                });
                const pct = allT.length ? Math.round((done/allT.length)*100) : 0;

                const pid = curId || Date.now();

                const p = {
                    id: pid,
                    archived: arch,
                    lid: lineId, lname: l.n, lcode: l.t,
                    cdt: document.getElementById('inp-cdt').value,
                    cdtSup: document.getElementById('inp-cdt-sup').value,
                    start: document.getElementById('inp-start').value,
                    end: document.getElementById('inp-end').value,
                    consStart: document.getElementById('inp-cons-start').value,
                    consEnd: document.getElementById('inp-cons-end').value,
                    ots: [...ots], ois: [...ois],
                    pct: pct,
                    states: {...states},
                    manual: manualData,
                    desc: document.getElementById('inp-desc').value,
                    depl: isDepl
                };
                
                // ENVOI FIREBASE
                set(ref(db, 'chantiers/' + pid), p)
                .then(() => {
                    if(arch) goArchive(); 
                    else {
                        alert("Enregistr√© et Partag√© !");
                        goHome();
                    }
                })
                .catch((e) => alert("Erreur Firebase: " + e));

            } catch (err) {
                console.error(err);
                alert("Erreur JS: " + err.message);
            }
        }

        function load(id) {
            const p = projects.find(x=>x.id===Number(id)) || projects.find(x=>x.id===String(id));
            if(!p) return;
            curId = p.id; states = p.states || {}; ots = p.ots||[]; ois = p.ois||[];
            
            document.getElementById('inp-line').value = p.lid;
            document.getElementById('inp-cdt').value = p.cdt;
            document.getElementById('inp-cdt-sup').value = p.cdtSup||'';
            document.getElementById('inp-start').value = p.start;
            document.getElementById('inp-end').value = p.end;
            document.getElementById('inp-cons-start').value = p.consStart||'';
            document.getElementById('inp-cons-end').value = p.consEnd||'';
            document.getElementById('inp-desc').value = p.desc;
            
            const elDepl = document.getElementById('inp-depl');
            if(elDepl) elDepl.checked = p.depl || false;
            
            if(p.manual) {
                Object.keys(p.manual).forEach(k => {
                    const el = document.getElementById('val-'+k);
                    if(el) el.value = p.manual[k];
                });
            }

            updateHeader(); renderTags('ot'); renderTags('oi'); refreshUI(); switchScreen('screen-form');
        }

        function newItem() {
            curId = null; states = {}; ots=[]; ois=[];
            document.querySelectorAll('input,textarea,select').forEach(i=>i.value='');
            const elDepl = document.getElementById('inp-depl');
            if(elDepl) elDepl.checked = false;
            document.getElementById('display-line-header').textContent = "NOUVEAU CHANTIER";
            refreshUI(); switchScreen('screen-form');
        }

        function renderHome() { renderGrid('grid-projects', false); }
        function renderGrid(domId, isArch) {
            const d = document.getElementById(domId); d.innerHTML = '';
            const lst = projects.filter(p=>!!p.archived === isArch);
            if(!lst.length) { d.innerHTML='<div style="text-align:center;color:#999">Aucun dossier</div>'; return; }

            const today = new Date(); today.setHours(0,0,0,0);

            lst.forEach(p => {
                let alertsHtml = '';
                const allT = [...confLog.flatMap(x=>x.t), ...confPrep.flatMap(x=>x.t)];
                let globalStatus = 'green';
                
                if(p.start) {
                    allT.forEach(t => {
                        if(t.type === 'input') return;
                        if(p.states[t.id]) return;
                        if(!t.d) return;

                        const due = new Date(p.start); due.setDate(due.getDate() - t.d);
                        if(today > due) {
                            globalStatus = 'red';
                            alertsHtml += `<div class="alert-item alert-red">‚ö†Ô∏è ${t.l}</div>`;
                        } else {
                            let warn = new Date(due);
                            if(t.d >= 30) warn.setMonth(warn.getMonth()-1); else warn.setDate(warn.getDate()-5);
                            if(today >= warn) {
                                if(globalStatus !== 'red') globalStatus = 'yellow';
                                alertsHtml += `<div class="alert-item alert-orange">üïí ${t.l}</div>`;
                            }
                        }
                    });
                }
                if(alertsHtml) alertsHtml = `<div class="card-alerts">${alertsHtml}</div>`;

                const borderClass = globalStatus==='red'?'card-red':(globalStatus==='yellow'?'card-yellow':'card-green');
                const gaugeColor = p.pct===100 ? '#10b981' : (globalStatus==='red' ? '#ef4444' : '#0055a4');

                const card = document.createElement('div');
                card.className = `project-card ${borderClass}`;
                card.onclick = () => load(p.id);
                card.innerHTML = `
                    <div style="padding-right:70px">
                        <div class="card-title">${p.lcode} - ${p.lname}</div>
                        <div class="card-dates">üìÖ Du ${p.start?new Date(p.start).toLocaleDateString():'?'} au ${p.end?new Date(p.end).toLocaleDateString():'?'}</div>
                        <div class="card-dates">üë§ ${p.cdt||'-'}</div>
                        ${alertsHtml}
                    </div>
                    <div class="mini-gauge">
                        <svg viewBox="0 0 36 36" class="circular-chart">
                            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                            <path class="circle" stroke-dasharray="${p.pct}, 100" stroke="${gaugeColor}" fill="none" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        </svg>
                        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:0.8rem; font-weight:bold">${p.pct}%</div>
                    </div>
                `;
                d.appendChild(card);
            });
        }
        
        function doArchive() { if(confirm("Archiver ?")) save(true); }

        // EXPOSE FUNCTIONS TO WINDOW FOR HTML BUTTONS
        window.save = save;
        window.load = load;
        window.goHome = goHome;
        window.goArchive = goArchive;
        window.goPrepa = goPrepa;
        window.newItem = newItem;
        window.doArchive = doArchive;
        window.set = set;
        window.refreshUI = refreshUI;
        window.addTag = addTag;
        window.removeTag = removeTag;
        window.updateHeader = updateHeader;
        window.switchScreen = switchScreen;
    </script>
</body>
</html>
